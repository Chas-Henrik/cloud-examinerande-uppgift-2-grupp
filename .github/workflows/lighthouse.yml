# .github/workflows/lighthouse.yml

name: Lighthouse CI

on:
  push:           # triggers lint-and-test on all branches
  pull_request:   # triggers Lighthouse CI on PRs
    branches:
      - main
      - development
jobs:
  lighthouseci:
    runs-on: ubuntu-latest

    steps:
      # 1. Clone the repo into the GitHub Actions runner
      - uses: actions/checkout@v4
        with:
            ref: ${{ github.event.push.head.sha }}

      # 2. Install correct Node version
      - uses: actions/setup-node@v4
        with:
          node-version: 22

      # 3. Install dependencies and LHCI CLI globally
      - run: npm ci && npm install -g @lhci/cli@0.15.x

      # 4. Capture Vercel Preview URL
      - name: Deploy to Vercel Preview
        id: vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          github-comment: true

      # 5. Save Vercel Preview URL as an environment variable for subsequent steps
      - name: Set Vercel Preview URL env
        run: echo "PREVIEW_URL=${{ steps.vercel.outputs.preview-url }}/login" >> $GITHUB_ENV

      # 6. Run Lighthouse mobile audit
      - name: Lighthouse mobile audit
        run: lhci autorun --collect.headers="x-vercel-protection-bypass: ${{ env.VERCEL_AUTOMATION_BYPASS_SECRET }}"
        continue-on-error: true  # do not fail CI if LHCI fails
        env:
          LHCI_URL: "${{ env.PREVIEW_URL }}"
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          LHCI_BUILD_CONTEXT__CURRENT_HASH: ${{ github.event.push.head.sha }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}

      # 7. Run Lighthouse desktop audit
      - name: Lighthouse desktop audit
        run: lhci autorun --collect.settings.preset=desktop --collect.headers="x-vercel-protection-bypass: ${{ env.VERCEL_AUTOMATION_BYPASS_SECRET }}"
        continue-on-error: true  # do not fail CI if LHCI fails
        env:
          LHCI_URL: "${{ env.PREVIEW_URL }}"
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          LHCI_BUILD_CONTEXT__CURRENT_HASH: ${{ github.event.push.head.sha }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
